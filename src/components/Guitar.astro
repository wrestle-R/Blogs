---
// Guitar component using react-guitar library
---

<section class="guitar-section" id="react-guitar-container">
    <h2 class="guitar-title">React Guitar</h2>
    <div class="guitar-wrapper">
        <div id="guitar-root"></div>
    </div>
</section>

<script>
    // @ts-nocheck
    import Guitar from 'react-guitar';
    import React from 'react';
    import ReactDOM from 'react-dom/client';
    import * as Tone from 'tone';

    if (typeof window !== 'undefined') {
        let sampler: Tone.Sampler | null = null;
        let isAudioInitialized = false;

        // Initialize Tone.js sampler
        async function initAudio() {
            if (!isAudioInitialized) {
                await Tone.start();
                sampler = new Tone.Sampler({
                    urls: {
                        A2: "A2.mp3",
                        A3: "A3.mp3",
                        A4: "A4.mp3",
                        C3: "C3.mp3",
                        C4: "C4.mp3",
                    },
                    baseUrl: "https://tonejs.github.io/audio/salamander/",
                    onload: () => {
                        console.log("Guitar samples loaded");
                    }
                }).toDestination();
                isAudioInitialized = true;
            }
        }

        const GuitarComponent = () => {
            // Display open strings only (all zeros = open strings, no frets pressed)
            const strings = [0, 0, 0, 0, 0, 0];

            const tunings = ['E', 'A', 'D', 'G', 'B', 'E'];
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            const noteOctaveMap = {
                'C': 'C3', 'C#': 'C#3', 'D': 'D3', 'D#': 'D#3',
                'E': 'E3', 'F': 'F3', 'F#': 'F#3', 'G': 'G3',
                'G#': 'G#3', 'A': 'A3', 'A#': 'A#3', 'B': 'B3',
            };

            function getNote(openNote, fretNumber) {
                const noteIndex = notes.indexOf(openNote);
                const newNoteIndex = (noteIndex + fretNumber) % 12;
                return notes[newNoteIndex];
            }

            async function playNote(noteName) {
                await initAudio();
                if (sampler && sampler.loaded) {
                    const noteWithOctave = noteOctaveMap[noteName] || 'C3';
                    sampler.triggerAttackRelease(noteWithOctave, "0.5");
                }
            }

            const handlePlay = async (stringIndex) => {
                // Play the open string note (since strings array is all zeros)
                const openNote = tunings[stringIndex];
                await playNote(openNote);
            };

            return React.createElement(Guitar, {
                strings: strings,
                frets: { from: 0, amount: 12 },
                // No onChange - makes it non-interactive (read-only)
                playOnHover: true,
                onPlay: handlePlay
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('guitar-root');
            if (container && !container.hasChildNodes()) {
                const root = ReactDOM.createRoot(container);
                root.render(React.createElement(GuitarComponent));
            }
        });

        // Also handle Astro page transitions
        document.addEventListener('astro:page-load', () => {
            const container = document.getElementById('guitar-root');
            if (container && !container.hasChildNodes()) {
                const root = ReactDOM.createRoot(container);
                root.render(React.createElement(GuitarComponent));
            }
        });
    }
</script>

<style is:global>
    .guitar-section {
        width: 100%;
        margin: 2rem 0;
        display: block;
    }

    .guitar-title {
        text-align: left;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: oklch(0.3 0 0);
    }

    :root[data-theme='dark'] .guitar-title {
        color: oklch(0.9 0 0);
    }

    @media (max-width: 768px) {
        .guitar-section {
            display: none;
        }
    }

    .guitar-wrapper {
        position: relative;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        min-height: 250px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: oklch(0.995 0 0);
        border-radius: 0.75rem;
        border: 1px solid oklch(0.9 0 0);
        transition: background-color 0.3s ease, border-color 0.3s ease;
        overflow: visible;
    }

    :root[data-theme='dark'] .guitar-wrapper {
        background: oklch(0.16 0 0);
        border-color: oklch(1 0 0 / 8%);
    }

    #guitar-root {
        width: 100%;
        max-width: 800px;
    }

    /* Customize react-guitar styling to match VirtualGuitar */
    #guitar-root .Guitar {
        background: transparent !important;
        padding: 1rem 0;
    }

    /* Fretboard styling */
    #guitar-root .Guitar__fretboard {
        background: linear-gradient(to right,
            oklch(0.85 0.05 80),
            oklch(0.82 0.04 75)
        ) !important;
        border-radius: 4px;
        box-shadow: inset 0 2px 8px oklch(0 0 0 / 0.1);
    }

    :root[data-theme='dark'] #guitar-root .Guitar__fretboard {
        background: linear-gradient(to right,
            oklch(0.25 0.02 80),
            oklch(0.22 0.02 75)
        ) !important;
        box-shadow: inset 0 2px 8px oklch(0 0 0 / 0.3);
    }

    /* Fret styling */
    #guitar-root .Guitar__fret {
        border-right: 2px solid oklch(0.7 0 0) !important;
        opacity: 0.5;
    }

    :root[data-theme='dark'] #guitar-root .Guitar__fret {
        border-right: 2px solid oklch(0.4 0 0) !important;
        opacity: 0.6;
    }

    /* String styling */
    #guitar-root .Guitar__string {
        background: linear-gradient(to bottom,
            oklch(0.5 0 0 / 0.8),
            oklch(0.5 0 0),
            oklch(0.5 0 0 / 0.8)
        ) !important;
        box-shadow: 0 2px 4px oklch(0.2 0 0 / 0.2),
                    inset 0 1px 0 oklch(0.995 0 0 / 0.1) !important;
        border-radius: 1px;
        transition: filter 0.1s ease, transform 0.1s ease;
    }

    #guitar-root .Guitar__string:hover {
        filter: brightness(1.2);
        transform: scaleY(1.1);
    }

    :root[data-theme='dark'] #guitar-root .Guitar__string {
        background: linear-gradient(to bottom,
            oklch(0.65 0 0 / 0.9),
            oklch(0.65 0 0),
            oklch(0.65 0 0 / 0.9)
        ) !important;
        box-shadow: 0 2px 4px oklch(0 0 0 / 0.5),
                    inset 0 1px 0 oklch(0.95 0 0 / 0.2) !important;
    }

    /* Fret markers (dots) */
    #guitar-root .Guitar__fret-marker {
        background: oklch(0.75 0 0) !important;
        opacity: 0.5;
        box-shadow: 0 1px 3px oklch(0 0 0 / 0.3);
    }

    :root[data-theme='dark'] #guitar-root .Guitar__fret-marker {
        background: oklch(0.4 0 0) !important;
        opacity: 0.6;
    }

    /* String labels */
    #guitar-root .Guitar__string-label {
        font-size: 1.25rem;
        font-weight: bold;
        color: oklch(0.25 0 0);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    #guitar-root .Guitar__string-label:hover {
        color: oklch(0.45 0.15 250);
        transform: scale(1.1);
    }

    :root[data-theme='dark'] #guitar-root .Guitar__string-label {
        color: oklch(0.9 0 0);
    }

    :root[data-theme='dark'] #guitar-root .Guitar__string-label:hover {
        color: oklch(0.7 0.15 250);
    }

    /* Active fret (finger position) */
    #guitar-root .Guitar__string--active {
        filter: brightness(1.3);
        animation: stringVibrate 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes stringVibrate {
        0% {
            transform: scaleY(1) translateY(0);
            filter: brightness(1.4);
        }
        10% {
            transform: scaleY(1.02) translateY(-2.5px);
        }
        20% {
            transform: scaleY(1.02) translateY(2px);
        }
        30% {
            transform: scaleY(1.015) translateY(-1.5px);
        }
        40% {
            transform: scaleY(1.01) translateY(1px);
        }
        50% {
            transform: scaleY(1.005) translateY(-0.8px);
        }
        60% {
            transform: scaleY(1.002) translateY(0.5px);
        }
        70% {
            transform: scaleY(1.001) translateY(-0.3px);
            filter: brightness(1.1);
        }
        85% {
            transform: scaleY(1) translateY(0.1px);
        }
        100% {
            transform: scaleY(1) translateY(0);
            filter: brightness(1);
        }
    }

    @media (max-width: 768px) {
        .guitar-wrapper {
            min-height: 150px;
            padding: 1rem;
        }
    }
</style>
