---
import Layout from '../layouts/Layout.astro';
---

<Layout >
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="mb-8 text-center space-y-4">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-foreground to-muted-foreground bg-clip-text text-transparent">
        What I'm Vibing To
      </h1>
      <p class="text-base text-muted-foreground">Live from my Spotify feed</p>
      
      <!-- Navigation to Songs Page -->
      <a 
        href="/songs" 
        class="inline-flex items-center gap-2 px-5 py-2.5 bg-primary text-primary-foreground rounded-lg hover:opacity-90 hover:scale-105 transition-all font-medium text-sm shadow-sm hover:shadow-md"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span>Add a song you like</span>
      </a>
    </div>
    
    <div id="loading-section" class="space-y-6 min-h-[800px]">
      <!-- Now Playing Skeleton -->
      <div class="rounded-lg border bg-card overflow-hidden">
        <div class="p-6 bg-gradient-to-br from-primary/5 to-transparent">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-5 h-5 bg-muted animate-pulse rounded"></div>
            <div class="h-6 w-32 bg-muted animate-pulse rounded"></div>
          </div>
          
          <div class="flex gap-4 items-start flex-col sm:flex-row">
            <div class="w-full sm:w-32 h-32 bg-muted animate-pulse rounded-lg flex-shrink-0 relative overflow-hidden flex items-center justify-center">
              <svg class="w-16 h-16 text-muted-foreground/20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
              </svg>
            </div>
            
            <div class="flex-1 min-w-0 w-full space-y-3">
              <div class="flex items-center gap-2">
                <div class="h-8 flex-1 bg-muted animate-pulse rounded"></div>
                <div class="w-9 h-9 bg-muted animate-pulse rounded-full flex-shrink-0"></div>
              </div>
              <div class="h-5 w-3/4 bg-muted animate-pulse rounded"></div>
              <div class="h-4 w-1/2 bg-muted animate-pulse rounded"></div>
              
              <div class="mt-4 space-y-2">
                <div class="flex items-center gap-3">
                  <div class="h-3 w-10 bg-muted animate-pulse rounded"></div>
                  <div class="flex-1 h-1.5 bg-muted animate-pulse rounded-full"></div>
                  <div class="h-3 w-10 bg-muted animate-pulse rounded"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Skeleton -->
      <div class="rounded-lg border bg-card">
        <div class="flex items-center justify-between p-4 border-b bg-muted/30">
          <div class="h-6 w-28 bg-muted animate-pulse rounded"></div>
          <div class="flex gap-1 p-1 bg-muted rounded-md">
            <div class="h-8 w-20 bg-muted-foreground/20 animate-pulse rounded"></div>
            <div class="h-8 w-20 bg-muted-foreground/20 animate-pulse rounded"></div>
            <div class="h-8 w-24 bg-muted-foreground/20 animate-pulse rounded"></div>
          </div>
        </div>

        <div class="p-4 space-y-2">
          <!-- Track Item Skeletons -->
          <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg skeleton-item">
            <div class="w-6 sm:w-8 h-6 bg-muted animate-pulse rounded flex-shrink-0"></div>
            <div class="w-12 h-12 sm:w-14 sm:h-14 bg-muted animate-pulse rounded-md flex-shrink-0 relative overflow-hidden flex items-center justify-center">
              <svg class="w-6 h-6 text-muted-foreground/20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
              </svg>
            </div>
            <div class="flex-1 space-y-2 min-w-0">
              <div class="h-5 w-3/4 bg-muted animate-pulse rounded"></div>
              <div class="h-4 w-1/2 bg-muted animate-pulse rounded"></div>
            </div>
            <div class="w-5 h-5 bg-muted animate-pulse rounded-full flex-shrink-0"></div>
          </div>
          
          <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg skeleton-item">
            <div class="w-6 sm:w-8 h-6 bg-muted animate-pulse rounded flex-shrink-0"></div>
            <div class="w-12 h-12 sm:w-14 sm:h-14 bg-muted animate-pulse rounded-md flex-shrink-0 relative overflow-hidden flex items-center justify-center">
              <svg class="w-6 h-6 text-muted-foreground/20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
              </svg>
            </div>
            <div class="flex-1 space-y-2 min-w-0">
              <div class="h-5 w-2/3 bg-muted animate-pulse rounded"></div>
              <div class="h-4 w-1/3 bg-muted animate-pulse rounded"></div>
            </div>
            <div class="w-5 h-5 bg-muted animate-pulse rounded-full flex-shrink-0"></div>
          </div>
          
          <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg skeleton-item">
            <div class="w-6 sm:w-8 h-6 bg-muted animate-pulse rounded flex-shrink-0"></div>
            <div class="w-12 h-12 sm:w-14 sm:h-14 bg-muted animate-pulse rounded-md flex-shrink-0 relative overflow-hidden flex items-center justify-center">
              <svg class="w-6 h-6 text-muted-foreground/20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
              </svg>
            </div>
            <div class="flex-1 space-y-2 min-w-0">
              <div class="h-5 w-4/5 bg-muted animate-pulse rounded"></div>
              <div class="h-4 w-2/5 bg-muted animate-pulse rounded"></div>
            </div>
            <div class="w-5 h-5 bg-muted animate-pulse rounded-full flex-shrink-0"></div>
          </div>

          <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg skeleton-item">
            <div class="w-6 sm:w-8 h-6 bg-muted animate-pulse rounded flex-shrink-0"></div>
            <div class="w-12 h-12 sm:w-14 sm:h-14 bg-muted animate-pulse rounded-md flex-shrink-0 relative overflow-hidden flex items-center justify-center">
              <svg class="w-6 h-6 text-muted-foreground/20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
              </svg>
            </div>
            <div class="flex-1 space-y-2 min-w-0">
              <div class="h-5 w-3/5 bg-muted animate-pulse rounded"></div>
              <div class="h-4 w-2/5 bg-muted animate-pulse rounded"></div>
            </div>
            <div class="w-5 h-5 bg-muted animate-pulse rounded-full flex-shrink-0"></div>
          </div>

          <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg skeleton-item">
            <div class="w-6 sm:w-8 h-6 bg-muted animate-pulse rounded flex-shrink-0"></div>
            <div class="w-12 h-12 sm:w-14 sm:h-14 bg-muted animate-pulse rounded-md flex-shrink-0 relative overflow-hidden flex items-center justify-center">
              <svg class="w-6 h-6 text-muted-foreground/20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
              </svg>
            </div>
            <div class="flex-1 space-y-2 min-w-0">
              <div class="h-5 w-1/2 bg-muted animate-pulse rounded"></div>
              <div class="h-4 w-1/3 bg-muted animate-pulse rounded"></div>
            </div>
            <div class="w-5 h-5 bg-muted animate-pulse rounded-full flex-shrink-0"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="error-section" class="hidden mb-6">
      <div class="bg-destructive/10 border border-destructive/20 rounded-lg p-4 text-center">
        <h2 class="text-lg font-semibold mb-1">Error</h2>
        <p id="error-message" class="text-sm text-muted-foreground mb-3"></p>
        <button 
          id="retry-button"
          class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground text-sm font-medium rounded-md hover:opacity-90 transition-opacity"
        >
          Retry
        </button>
      </div>
    </div>

    <div id="content-section" class="hidden space-y-6">
      <div id="now-playing-section" class="rounded-lg border bg-card overflow-hidden">
        <div class="p-6 bg-gradient-to-br from-primary/5 to-transparent">
          <h2 id="section-title" class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg id="section-icon" class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="section-title-text">Now Playing</span>
          </h2>
        
        <div id="now-playing-card" class="hidden">
          <div class="flex gap-4 items-start flex-col sm:flex-row">
            <img 
              id="album-art" 
              src="" 
              alt="Album Art" 
              class="w-full sm:w-32 h-32 rounded-lg shadow-lg object-cover flex-shrink-0"
            />
            
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                <h3 id="song-name" class="text-2xl font-bold flex-1 break-words"></h3>
                <a 
                  id="spotify-link-title" 
                  href="" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="p-2 hover:bg-primary/10 rounded-full transition-colors flex-shrink-0"
                  title="Open in Spotify"
                >
                  <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                  </svg>
                </a>
              </div>
              <p id="artist-name" class="text-base text-muted-foreground mb-1 break-words"></p>
              <p id="album-name" class="text-sm text-muted-foreground/70 break-words"></p>
              
              <div class="mt-4 space-y-3">
                <div class="flex items-center gap-3 text-xs">
                  <span id="current-time" class="text-muted-foreground font-medium min-w-[2.5rem]">0:00</span>
                  <div class="flex-1 bg-muted rounded-full h-1.5 overflow-hidden">
                    <div id="progress-bar" class="bg-primary h-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <span id="total-time" class="text-muted-foreground font-medium min-w-[2.5rem]">0:00</span>
                </div>
                
                <!-- Audio Player Controls -->
                <div id="now-playing-player" class="hidden">
                  <div class="flex items-center gap-3 p-3 bg-muted/30 rounded-lg">
                    <button 
                      id="now-play-pause-btn" 
                      class="w-9 h-9 flex items-center justify-center rounded-full bg-primary hover:bg-primary/90 text-primary-foreground transition-colors flex-shrink-0"
                      title="Play preview"
                    >
                      <svg id="now-play-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                      </svg>
                      <svg id="now-pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                      </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                      <input 
                        id="now-audio-seek" 
                        type="range" 
                        min="0" 
                        max="100" 
                        value="0" 
                        class="w-full h-1.5 bg-muted rounded-full appearance-none cursor-pointer audio-seek-slider"
                      />
                      <div class="flex items-center justify-between text-xs text-muted-foreground mt-1">
                        <span id="now-audio-current">0:00</span>
                        <span id="now-audio-duration">0:30</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <audio id="now-audio-element" preload="auto"></audio>
        </div>

        <div id="last-played-card" class="hidden">
          <div class="flex gap-4 items-start flex-col sm:flex-row">
            <img 
              id="last-album-art" 
              src="" 
              alt="Album Art" 
              class="w-full sm:w-32 h-32 rounded-lg shadow-lg object-cover flex-shrink-0"
            />
            
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                <h3 id="last-song-name" class="text-2xl font-bold flex-1 break-words"></h3>
                <a 
                  id="last-spotify-link-title" 
                  href="" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="p-2 hover:bg-primary/10 rounded-full transition-colors flex-shrink-0"
                  title="Open in Spotify"
                >
                  <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                  </svg>
                </a>
              </div>
              <p id="last-artist-name" class="text-base text-muted-foreground mb-1 break-words"></p>
              <p id="last-album-name" class="text-sm text-muted-foreground/70 break-words"></p>
              <p id="last-played-time" class="text-xs text-muted-foreground/60 mt-3 font-medium"></p>
              
              <!-- Audio Player Controls -->
              <div id="last-played-player" class="hidden mt-4">
                <div class="flex items-center gap-3 p-3 bg-muted/30 rounded-lg">
                  <button 
                    id="last-play-pause-btn" 
                    class="w-9 h-9 flex items-center justify-center rounded-full bg-primary hover:bg-primary/90 text-primary-foreground transition-colors flex-shrink-0"
                    title="Play preview"
                  >
                    <svg id="last-play-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="last-pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                  </button>
                  <div class="flex-1 min-w-0">
                    <input 
                      id="last-audio-seek" 
                      type="range" 
                      min="0" 
                      max="100" 
                      value="0" 
                      class="w-full h-1.5 bg-muted rounded-full appearance-none cursor-pointer audio-seek-slider"
                    />
                    <div class="flex items-center justify-between text-xs text-muted-foreground mt-1">
                      <span id="last-audio-current">0:00</span>
                      <span id="last-audio-duration">0:30</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <audio id="last-audio-element" preload="auto"></audio>
        </div>

        <div id="not-playing-card" class="hidden text-center py-12">
          <svg class="w-16 h-16 mx-auto mb-4 text-muted-foreground/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
          </svg>
          <p class="text-sm text-muted-foreground">No music activity yet</p>
        </div>
        </div>
      </div>

      <div class="rounded-lg border bg-card">
        <div class="flex items-center justify-between p-4 border-b bg-muted/30">
          <h2 class="text-lg font-semibold">My Music</h2>
          <div class="flex gap-1 p-1 bg-muted rounded-md" role="tablist">
            <button
              class="view-toggle px-3 py-1.5 text-xs font-medium rounded transition-all"
              data-view="tracks"
              data-active="true"
            >
              Tracks
            </button>
            <button
              class="view-toggle px-3 py-1.5 text-xs font-medium rounded transition-all"
              data-view="artists"
              data-active="false"
            >
              Artists
            </button>
            <button
              class="view-toggle px-3 py-1.5 text-xs font-medium rounded transition-all"
              data-view="playlists"
              data-active="false"
            >
              Playlists
            </button>
          </div>
        </div>

        <div class="p-4">
          <div id="tracks-view" class="view-content" data-active="true">
            <div id="top-tracks-list" class="space-y-2"></div>
          </div>

          <div id="artists-view" class="view-content hidden" data-active="false">
            <div id="top-artists-list" class="space-y-2"></div>
          </div>

          <div id="playlists-view" class="view-content hidden" data-active="false">
            <div id="playlists-list" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const API_BASE_URL = 'https://blogsbackend.vidyoyo.workers.dev';
  
  const formatTime = (ms: number) => {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  const formatAudioTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Audio player class to handle playback
  class AudioPlayer {
    private audio: HTMLAudioElement;
    private playPauseBtn: HTMLButtonElement;
    private playIcon: HTMLElement;
    private pauseIcon: HTMLElement;
    private seekSlider: HTMLInputElement;
    private currentTimeEl: HTMLElement;
    private durationEl: HTMLElement;
    private playerContainer: HTMLElement;
    private previewUrl: string | null = null;

    constructor(prefix: 'now' | 'last') {
      this.audio = document.getElementById(`${prefix}-audio-element`) as HTMLAudioElement;
      this.playPauseBtn = document.getElementById(`${prefix}-play-pause-btn`) as HTMLButtonElement;
      this.playIcon = document.getElementById(`${prefix}-play-icon`) as HTMLElement;
      this.pauseIcon = document.getElementById(`${prefix}-pause-icon`) as HTMLElement;
      this.seekSlider = document.getElementById(`${prefix}-audio-seek`) as HTMLInputElement;
      this.currentTimeEl = document.getElementById(`${prefix}-audio-current`) as HTMLElement;
      this.durationEl = document.getElementById(`${prefix}-audio-duration`) as HTMLElement;
      
      // Handle different ID patterns for the container
      if (prefix === 'now') {
        this.playerContainer = document.getElementById('now-playing-player') as HTMLElement;
      } else {
        this.playerContainer = document.getElementById('last-played-player') as HTMLElement;
      }

      this.setupEventListeners();
    }

    private setupEventListeners() {
      // Play/Pause button
      this.playPauseBtn?.addEventListener('click', () => {
        if (this.audio.paused) {
          this.play();
        } else {
          this.pause();
        }
      });

      // Seek slider
      this.seekSlider?.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        const time = (parseFloat(target.value) / 100) * this.audio.duration;
        this.audio.currentTime = time;
      });

      // Audio events
      this.audio?.addEventListener('loadedmetadata', () => {
        if (this.durationEl) {
          this.durationEl.textContent = formatAudioTime(this.audio.duration);
        }
        this.seekSlider.max = '100';
      });

      this.audio?.addEventListener('timeupdate', () => {
        if (!isNaN(this.audio.duration)) {
          const progress = (this.audio.currentTime / this.audio.duration) * 100;
          this.seekSlider.value = progress.toString();
          
          if (this.currentTimeEl) {
            this.currentTimeEl.textContent = formatAudioTime(this.audio.currentTime);
          }
        }
      });

      this.audio?.addEventListener('ended', () => {
        this.showPlayIcon();
        this.seekSlider.value = '0';
        if (this.currentTimeEl) {
          this.currentTimeEl.textContent = '0:00';
        }
      });

      this.audio?.addEventListener('error', () => {
        console.error('Audio playback error');
      });
    }

    async loadPreview(previewUrl: string | null) {
      this.previewUrl = previewUrl;
      
      if (previewUrl) {
        this.audio.src = previewUrl;
        this.audio.load();
        this.playerContainer?.classList.remove('hidden');
      } else {
        this.playerContainer?.classList.add('hidden');
      }
    }

    play() {
      if (this.previewUrl) {
        this.audio.play();
        this.showPauseIcon();
      }
    }

    pause() {
      this.audio.pause();
      this.showPlayIcon();
    }

    private showPlayIcon() {
      this.playIcon?.classList.remove('hidden');
      this.pauseIcon?.classList.add('hidden');
    }

    private showPauseIcon() {
      this.playIcon?.classList.add('hidden');
      this.pauseIcon?.classList.remove('hidden');
    }

    reset() {
      this.pause();
      this.audio.currentTime = 0;
      this.seekSlider.value = '0';
      if (this.currentTimeEl) {
        this.currentTimeEl.textContent = '0:00';
      }
    }
  }

  // Global audio player instances
  let nowPlayingPlayer: AudioPlayer | null = null;
  let lastPlayedPlayer: AudioPlayer | null = null;

  const hideLoading = () => {
    document.getElementById('loading-section')?.classList.add('hidden');
  };

  const showError = (message: string) => {
    hideLoading();
    document.getElementById('error-section')?.classList.remove('hidden');
    const errorMsg = document.getElementById('error-message');
    if (errorMsg) errorMsg.textContent = message;
  };

  const showContent = () => {
    const loadingSection = document.getElementById('loading-section');
    const contentSection = document.getElementById('content-section');
    const errorSection = document.getElementById('error-section');
    
    if (loadingSection) {
      loadingSection.style.opacity = '0';
      setTimeout(() => {
        loadingSection.classList.add('hidden');
      }, 300);
    }
    
    errorSection?.classList.add('hidden');
    
    if (contentSection) {
      contentSection.classList.remove('hidden');
      setTimeout(() => {
        contentSection.style.opacity = '1';
      }, 50);
    }
  };

  const loadLastPlayed = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/last-played`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch last played');
      }

      const data = await response.json();

      if (!data.name) {
        document.getElementById('last-played-card')?.classList.add('hidden');
        document.getElementById('not-playing-card')?.classList.remove('hidden');
        updateSectionHeader('Nothing Playing', 'music');
        return;
      }

      document.getElementById('not-playing-card')?.classList.add('hidden');
      document.getElementById('last-played-card')?.classList.remove('hidden');
      
      // Update section header to "Last Played"
      updateSectionHeader('Last Played', 'clock');

      const albumArt = document.getElementById('last-album-art') as HTMLImageElement;
      const songName = document.getElementById('last-song-name');
      const artistName = document.getElementById('last-artist-name');
      const albumName = document.getElementById('last-album-name');
      const playedTime = document.getElementById('last-played-time');
      const spotifyLink = document.getElementById('last-spotify-link-title') as HTMLAnchorElement;

      if (albumArt) albumArt.src = data.albumArt || '';
      if (songName) songName.textContent = data.name;
      if (artistName) artistName.textContent = data.artist;
      if (albumName) albumName.textContent = data.album;
      if (spotifyLink) spotifyLink.href = data.songUrl;

      // Format the played time
      if (playedTime && data.playedAt) {
        const playedDate = new Date(data.playedAt);
        const now = new Date();
        const diffMs = now.getTime() - playedDate.getTime();
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        let timeAgo = '';
        if (diffDays > 0) {
          timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else if (diffHours > 0) {
          timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffMins > 0) {
          timeAgo = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        } else {
          timeAgo = 'Just now';
        }
        playedTime.textContent = timeAgo;
      }

      // Load audio preview
      if (lastPlayedPlayer) {
        if (data.previewUrl) {
          await lastPlayedPlayer.loadPreview(data.previewUrl);
        } else if (data.songUrl) {
          // Extract track ID from Spotify URL and fetch preview
          const trackIdMatch = data.songUrl.match(/track\/([a-zA-Z0-9]+)/);
          if (trackIdMatch) {
            const trackId = trackIdMatch[1];
            try {
              const previewResponse = await fetch(`${API_BASE_URL}/api/preview/${trackId}`);
              const previewData = await previewResponse.json();
              
              if (previewData.preview_url) {
                await lastPlayedPlayer.loadPreview(previewData.preview_url);
              }
            } catch (error) {
              console.error('Error fetching preview URL:', error);
            }
          }
        }
      }
    } catch (error) {
      console.error('Error loading last played:', error);
      document.getElementById('last-played-card')?.classList.add('hidden');
      document.getElementById('not-playing-card')?.classList.remove('hidden');
      updateSectionHeader('Nothing Playing', 'music');
    }
  };

  const updateSectionHeader = (title: string, iconType: 'play' | 'clock' | 'music') => {
    const titleText = document.getElementById('section-title-text');
    const icon = document.getElementById('section-icon');
    
    if (titleText) titleText.textContent = title;
    
    if (icon) {
      if (iconType === 'play') {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
      } else if (iconType === 'clock') {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />';
      }
    }
  };

  const updateNowPlaying = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/now-playing`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch now playing');
      }

      const data = await response.json();

      if (!data.isPlaying || !data.name) {
        // If nothing is playing, fetch last played song
        document.getElementById('now-playing-card')?.classList.add('hidden');
        await loadLastPlayed();
        return;
      }

      document.getElementById('not-playing-card')?.classList.add('hidden');
      document.getElementById('last-played-card')?.classList.add('hidden');
      document.getElementById('now-playing-card')?.classList.remove('hidden');
      
      // Update section header to "Now Playing"
      updateSectionHeader('Now Playing', 'play');

      const albumArt = document.getElementById('album-art') as HTMLImageElement;
      const songName = document.getElementById('song-name');
      const artistName = document.getElementById('artist-name');
      const albumName = document.getElementById('album-name');
      const spotifyLink = document.getElementById('spotify-link-title') as HTMLAnchorElement;
      const progressBar = document.getElementById('progress-bar') as HTMLDivElement;
      const currentTime = document.getElementById('current-time');
      const totalTime = document.getElementById('total-time');

      if (albumArt) albumArt.src = data.albumArt || '';
      if (songName) songName.textContent = data.name;
      if (artistName) artistName.textContent = data.artist;
      if (albumName) albumName.textContent = data.album;
      if (spotifyLink) spotifyLink.href = data.songUrl;

      const progress = (data.progress / data.duration) * 100;
      if (progressBar) progressBar.style.width = `${progress}%`;
      if (currentTime) currentTime.textContent = formatTime(data.progress);
      if (totalTime) totalTime.textContent = formatTime(data.duration);

      // Load audio preview
      if (nowPlayingPlayer) {
        if (data.previewUrl) {
          await nowPlayingPlayer.loadPreview(data.previewUrl);
        } else if (data.songUrl) {
          // Extract track ID from Spotify URL and fetch preview
          const trackIdMatch = data.songUrl.match(/track\/([a-zA-Z0-9]+)/);
          if (trackIdMatch) {
            const trackId = trackIdMatch[1];
            try {
              const previewResponse = await fetch(`${API_BASE_URL}/api/preview/${trackId}`);
              const previewData = await previewResponse.json();
              
              if (previewData.preview_url) {
                await nowPlayingPlayer.loadPreview(previewData.preview_url);
              }
            } catch (error) {
              console.error('Error fetching preview URL:', error);
            }
          }
        }
      }
    } catch (error) {
      console.error('Error updating now playing:', error);
      document.getElementById('now-playing-card')?.classList.add('hidden');
      await loadLastPlayed();
    }
  };

  const loadTopTracks = async () => {
    try {
      // Determine limit based on screen size
      const isMobile = window.innerWidth < 768;
      const limit = isMobile ? 5 : 10;
      
      const response = await fetch(`${API_BASE_URL}/api/top-tracks?limit=${limit}`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch top tracks');
      }
      
      const data = await response.json();
      
      if (data.tracks && data.tracks.length > 0) {
        const tracksList = document.getElementById('top-tracks-list');
        
        if (tracksList) {
          tracksList.innerHTML = data.tracks.map((track: {
            albumArt: string;
            name: string;
            artist: string;
            songUrl: string;
            popularity: number;
          }, index: number) => `
            <a 
              href="${track.songUrl}" 
              target="_blank" 
              rel="noopener noreferrer"
              class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg hover:bg-muted/50 transition-all group cursor-pointer"
            >
              <span class="text-lg sm:text-xl font-bold text-muted-foreground/30 w-6 sm:w-8 flex-shrink-0">${index + 1}</span>
              <img src="${track.albumArt}" alt="${track.name}" class="w-12 h-12 sm:w-14 sm:h-14 rounded-md shadow-md flex-shrink-0" />
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-sm sm:text-base truncate">${track.name}</h3>
                <p class="text-xs sm:text-sm text-muted-foreground truncate">${track.artist}</p>
              </div>
              <div class="hidden md:flex items-center gap-2">
                <div class="w-16 lg:w-20 bg-muted rounded-full h-1.5 overflow-hidden">
                  <div class="bg-primary h-full transition-all" style="width: ${track.popularity}%"></div>
                </div>
                <span class="text-xs text-muted-foreground font-medium w-8">${track.popularity}%</span>
              </div>
            </a>
          `).join('');
        }
      }
    } catch (error) {
      console.error('Error loading top tracks:', error);
    }
  };  const loadTopArtists = async () => {
    try {
      // Determine limit based on screen size
      const isMobile = window.innerWidth < 768;
      const limit = isMobile ? 5 : 10;
      
      const response = await fetch(`${API_BASE_URL}/api/top-artists?limit=${limit}`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch top artists');
      }
      
      const data = await response.json();
      
      if (data.artists && data.artists.length > 0) {
        const artistsList = document.getElementById('top-artists-list');
        
        if (artistsList) {
          artistsList.innerHTML = data.artists.map((artist: any, index: number) => `
            <a 
              href="${artist.url}" 
              target="_blank" 
              rel="noopener noreferrer"
              class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg hover:bg-muted/50 transition-all group cursor-pointer"
            >
              <span class="text-lg sm:text-xl font-bold text-muted-foreground/30 w-6 sm:w-8 flex-shrink-0">${index + 1}</span>
              <img src="${artist.image}" alt="${artist.name}" class="w-12 h-12 sm:w-14 sm:h-14 rounded-full shadow-md object-cover flex-shrink-0" />
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-sm sm:text-base truncate">${artist.name}</h3>
                <p class="text-xs sm:text-sm text-muted-foreground truncate">${artist.genres.slice(0, 2).join(', ') || 'No genres'}</p>
              </div>
              <div class="hidden md:flex items-center gap-2">
                  <div class="w-16 lg:w-20 bg-muted rounded-full h-1.5 overflow-hidden">
                    <div class="bg-primary h-full transition-all" style="width: ${artist.popularity}%"></div>
                  </div>
                  <span class="text-xs text-muted-foreground font-medium w-8">${artist.popularity}%</span>
              </div>
            </a>
          `).join('');
        }
      }
    } catch (error) {
      console.error('Error fetching top artists:', error);
    }
  };  const loadPlaylists = async () => {
    try {
      // Determine limit based on screen size
      const isMobile = window.innerWidth < 768;
      const limit = isMobile ? 5 : 10;
      
      const response = await fetch(`${API_BASE_URL}/api/playlists`);
      if (!response.ok) {
        throw new Error('Failed to fetch playlists');
      }
      const data = await response.json();
      if (data.playlists && data.playlists.length > 0) {
        const playlistsList = document.getElementById('playlists-list');
        if (playlistsList) {
          playlistsList.innerHTML = data.playlists.slice(0, limit).map((playlist: {
            image: string;
            name: string;
            trackCount: number;
            isCollaborative: boolean;
            isPublic: boolean;
            url: string;
          }, index: number) => `
            <a 
              href="${playlist.url}" 
              target="_blank" 
              rel="noopener noreferrer"
              class="flex items-center gap-3 p-3 rounded-md hover:bg-muted/50 transition-colors group cursor-pointer"
            >
              <span class="text-lg font-bold text-muted-foreground/30 w-6">${index + 1}</span>
              <img src="${playlist.image || '/placeholder.png'}" alt="${playlist.name}" class="w-12 h-12 rounded shadow-sm" />
              <div class="flex-1 min-w-0">
                <h3 class="text-sm font-semibold truncate">${playlist.name}</h3>
                <p class="text-xs text-muted-foreground truncate">
                  ${playlist.trackCount} tracks${playlist.isCollaborative ? ' • Collaborative' : ''}${!playlist.isPublic ? ' • Private' : ''}
                </p>
              </div>
            </a>
          `).join('');
        }
      }
    } catch (error) {
      console.error('Error loading playlists:', error);
    }
  };

  const loadAllData = async () => {
    try {
      showContent();
      await Promise.all([
        updateNowPlaying(),
        loadTopTracks(),
        loadTopArtists(),
        loadPlaylists()
      ]);
    } catch (error) {
      showError(error instanceof Error ? error.message : 'Failed to load Spotify data');
    }
  };

  let updateInterval: ReturnType<typeof setInterval> | undefined;
  let lastScreenSize: 'mobile' | 'desktop' | null = null;

  // Function to detect screen size change
  const getScreenSize = (): 'mobile' | 'desktop' => {
    return window.innerWidth < 768 ? 'mobile' : 'desktop';
  };

  // Function to reload data if screen size category changed
  const handleResize = () => {
    const currentSize = getScreenSize();
    if (lastScreenSize !== null && lastScreenSize !== currentSize) {
      // Screen size category changed, reload the lists
      loadTopTracks();
      loadTopArtists();
      loadPlaylists();
    }
    lastScreenSize = currentSize;
  };

  // Initialize on page load
  document.addEventListener('astro:page-load', () => {
    // Initialize audio players
    nowPlayingPlayer = new AudioPlayer('now');
    lastPlayedPlayer = new AudioPlayer('last');

    // Set initial screen size
    lastScreenSize = getScreenSize();

    const toggleButtons = document.querySelectorAll('.view-toggle');
    const viewContents = document.querySelectorAll('.view-content');

    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const viewName = button.getAttribute('data-view');
        toggleButtons.forEach((btn) => {
          const isActive = btn.getAttribute('data-view') === viewName;
          btn.setAttribute('data-active', isActive.toString());
        });
        viewContents.forEach((content) => {
          const contentView = content.id.replace('-view', '').replace('top-', '');
          if (contentView === viewName) {
            content.setAttribute('data-active', 'true');
            content.classList.remove('hidden');
          } else {
            content.setAttribute('data-active', 'false');
            content.classList.add('hidden');
          }
        });
      });
    });

    document.getElementById('retry-button')?.addEventListener('click', loadAllData);

    // Add resize listener
    window.addEventListener('resize', handleResize);

    // Load data immediately
    loadAllData();

    // Clear any existing interval
    if (updateInterval) {
      clearInterval(updateInterval);
    }
    
    // Update now playing every second for more dynamic updates
    updateInterval = setInterval(updateNowPlaying, 1000);
  });

  // Clean up interval on page unload
  document.addEventListener('astro:before-preparation', () => {
    if (updateInterval) {
      clearInterval(updateInterval);
    }
    window.removeEventListener('resize', handleResize);
  });
</script>

<style>
  #loading-section {
    opacity: 1;
    transition: opacity 0.3s ease-in-out;
  }

  #content-section {
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
    min-height: 800px;
  }

  .view-toggle[data-active="true"] {
    background: oklch(0.995 0 0);
    color: oklch(0.2 0 0);
    box-shadow: 0 2px 8px 0 oklch(0.9 0 0);
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
  }
  .view-toggle[data-active="false"] {
    background: transparent;
    color: oklch(0.5 0 0);
    transition: color 0.2s;
  }
  .view-toggle[data-active="false"]:hover {
    color: oklch(0.2 0 0);
  }
  .view-toggle {
    border-radius: 0.5rem;
    padding: 0.375rem 1rem;
    font-size: 0.875rem;
    margin: 0 0.125rem;
    cursor: pointer;
    border: none;
    outline: none;
  }
  .view-content {
    animation: fadeIn 0.3s ease-in-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px);}
    to   { opacity: 1; transform: translateY(0);}
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  /* Stagger animation for skeleton items */
  .skeleton-item:nth-child(1) .animate-pulse { animation-delay: 0s; }
  .skeleton-item:nth-child(2) .animate-pulse { animation-delay: 0.1s; }
  .skeleton-item:nth-child(3) .animate-pulse { animation-delay: 0.2s; }
  .skeleton-item:nth-child(4) .animate-pulse { animation-delay: 0.3s; }
  .skeleton-item:nth-child(5) .animate-pulse { animation-delay: 0.4s; }

  /* Audio seek slider */
  .audio-seek-slider {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
  }
  
  .audio-seek-slider::-webkit-slider-track {
    background: hsl(var(--muted));
    border-radius: 9999px;
    height: 6px;
  }
  
  .audio-seek-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: hsl(var(--primary));
    cursor: pointer;
    margin-top: -4px;
    transition: transform 0.2s;
  }
  
  .audio-seek-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }
  
  .audio-seek-slider::-moz-range-track {
    background: hsl(var(--muted));
    border-radius: 9999px;
    height: 6px;
  }
  
  .audio-seek-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: hsl(var(--primary));
    cursor: pointer;
    border: none;
    transition: transform 0.2s;
  }
  
  .audio-seek-slider::-moz-range-thumb:hover {
    transform: scale(1.2);
  }
</style>
